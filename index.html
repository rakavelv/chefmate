<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChefMate AI - Ultimate Cooking Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=Playfair+Display:ital,wght@0,500;0,600;0,700;1,500&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        :root {
            --glass-border: rgba(255, 255, 255, 0.4);
            --glass-bg: rgba(255, 255, 255, 0.85);
        }

        body {
            font-family: 'Outfit', sans-serif;
            background-color: #FDFBF7;
            overflow-x: hidden;
            color: #1e293b;
        }
        h1, h2, h3, .serif {
            font-family: 'Playfair Display', serif;
        }
        
        /* Advanced Animated Background */
        .ambient-bg {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: -2;
            background: radial-gradient(circle at 15% 50%, rgba(255, 237, 213, 0.4), transparent 25%),
                        radial-gradient(circle at 85% 30%, rgba(254, 215, 170, 0.4), transparent 25%);
            animation: pulseBg 10s ease-in-out infinite alternate;
        }
        @keyframes pulseBg {
            0% { transform: scale(1); }
            100% { transform: scale(1.1); }
        }

        .floating-bg {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
            z-index: -1;
            overflow: hidden;
        }
        .floating-item {
            position: absolute;
            font-size: 2rem;
            opacity: 0.12;
            filter: blur(1px);
            animation: floatUp 20s linear infinite;
        }
        @keyframes floatUp {
            0% { transform: translateY(110vh) rotate(0deg); opacity: 0; }
            10% { opacity: 0.12; }
            90% { opacity: 0.12; }
            100% { transform: translateY(-10vh) rotate(360deg); opacity: 0; }
        }

        /* UI Animations */
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-slide-up {
            animation: slideUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }

        .glass-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
        }

        .recipe-card {
            transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
            transform-style: preserve-3d;
        }
        .recipe-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 25px 30px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        .skeleton-pulse {
            animation: skeleton 1.5s infinite ease-in-out;
            background-color: #e2e8f0;
        }
        @keyframes skeleton {
            0% { background-color: #e2e8f0; }
            50% { background-color: #f1f5f9; }
            100% { background-color: #e2e8f0; }
        }

        /* Scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #CBD5E1; border-radius: 20px; }

        /* Loader */
        .loader {
            width: 48px; height: 48px;
            border: 5px solid #FFF;
            border-bottom-color: #F97316;
            border-radius: 50%;
            display: inline-block;
            box-sizing: border-box;
            animation: rotation 1s linear infinite;
        }
        @keyframes rotation {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Chat UI Styles */
        .chat-bubble-user {
            background: #f97316; color: white; border-radius: 18px 18px 4px 18px;
            padding: 10px 16px; max-width: 80%; align-self: flex-end; margin-bottom: 8px;
            font-size: 0.9rem;
        }
        .chat-bubble-ai {
            background: #f1f5f9; color: #334155; border-radius: 18px 18px 18px 4px;
            padding: 10px 16px; max-width: 80%; align-self: flex-start; margin-bottom: 8px;
            font-size: 0.9rem;
        }
        .typing-dot {
            width: 6px; height: 6px; background: #cbd5e1; border-radius: 50%;
            animation: typing 1.4s infinite ease-in-out;
        }
        @keyframes typing { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-4px); } }

        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }
    </style>
</head>
<body class="text-slate-800 min-h-screen flex flex-col">

    <!-- Backgrounds -->
    <div class="ambient-bg"></div>
    <div id="floatingBg" class="floating-bg"></div>

    <!-- Navbar -->
    <nav class="glass-panel sticky top-0 z-40 shadow-sm">
        <div class="max-w-7xl mx-auto px-4 md:px-8 py-4 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="bg-gradient-to-tr from-orange-500 to-red-600 text-white p-2.5 rounded-xl shadow-lg shadow-orange-500/30">
                    <i data-lucide="chef-hat" class="w-6 h-6"></i>
                </div>
                <div>
                    <span class="text-2xl font-bold tracking-tight text-slate-900 block leading-none">ChefMate <span class="text-orange-600">AI</span></span>
                    <span class="text-xs text-slate-500 font-medium tracking-wide uppercase">Smart Kitchen</span>
                </div>
            </div>
            <div class="flex items-center gap-4">
                <div class="hidden md:flex items-center gap-6">
                    <button onclick="openHistoryModal()" class="text-sm font-medium text-slate-500 hover:text-orange-600 transition-colors flex items-center gap-1">
                        <i data-lucide="history" class="w-4 h-4"></i> History
                    </button>
                    <div class="flex items-center gap-2 bg-white/50 px-3 py-1.5 rounded-lg border border-white/60">
                        <i data-lucide="users" class="w-4 h-4 text-slate-500"></i>
                        <span class="text-sm font-medium text-slate-600">Cooking for:</span>
                        <input type="number" id="globalServings" min="1" max="30" value="2" onchange="updateServingsGlobal()" class="w-12 bg-transparent font-bold text-center border-b border-slate-300 focus:outline-none focus:border-orange-500">
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="flex-grow w-full max-w-7xl mx-auto px-4 md:px-8 py-8 md:py-12 z-10 relative">
        
        <!-- Hero Section -->
        <div class="grid lg:grid-cols-12 gap-12 items-start mb-16">
            <div class="lg:col-span-8 space-y-8 animate-slide-up">
                
                <h1 class="text-5xl md:text-6xl font-bold text-slate-900 leading-tight">
                    Discover perfect <span class="text-transparent bg-clip-text bg-gradient-to-r from-orange-500 to-red-600">Recipes</span> for your pantry.
                </h1>
                
                <!-- Advanced Control Panel -->
                <div class="glass-panel p-6 rounded-3xl shadow-xl shadow-orange-500/5">
                    
                    <!-- Search Bar -->
                    <div class="relative flex items-center mb-6">
                        <i data-lucide="search" class="absolute left-4 text-slate-400 w-5 h-5"></i>
                        <input type="text" id="ingredientInput" 
                            class="w-full pl-12 pr-4 py-4 bg-white/80 border border-slate-200 rounded-2xl focus:outline-none focus:ring-4 focus:ring-orange-100 focus:border-orange-300 transition-all text-lg placeholder:text-slate-400" 
                            placeholder="Add ingredients (e.g. tofu, soy sauce, chicken, rice)...">
                        <button onclick="addFromInput()" class="absolute right-2 bg-slate-900 hover:bg-slate-800 text-white p-2.5 rounded-xl transition-all">
                            <i data-lucide="plus" class="w-5 h-5"></i>
                        </button>
                    </div>

                    <!-- Tags -->
                    <div id="tagsContainer" class="flex flex-wrap gap-2 min-h-[40px] mb-6">
                        <span id="emptyState" class="text-slate-400 text-sm italic py-2">No ingredients added yet...</span>
                    </div>

                    <!-- Filters Row 1 -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                         <!-- Cuisine -->
                        <div class="relative group">
                            <select id="cuisineFilter" class="w-full pl-3 pr-8 py-2.5 bg-white/60 border border-slate-200 rounded-xl text-sm font-medium focus:border-orange-400 appearance-none cursor-pointer">
                                <option value="All">All Cuisines</option>
                                <option value="Indian">Indian üáÆüá≥</option>
                                <option value="Chinese">Chinese üá®üá≥</option>
                                <option value="Italian">Italian üáÆüáπ</option>
                                <option value="Mexican">Mexican üá≤üáΩ</option>
                                <option value="Asian">Asian ü•¢</option>
                                <option value="American">American üá∫üá∏</option>
                                <option value="Mediterranean">Mediterranean ü•ô</option>
                            </select>
                            <i data-lucide="chevron-down" class="absolute right-3 top-3 w-4 h-4 text-slate-400 pointer-events-none"></i>
                        </div>

                         <!-- Dish Type -->
                         <div class="relative group">
                            <select id="dishTypeFilter" class="w-full pl-3 pr-8 py-2.5 bg-white/60 border border-slate-200 rounded-xl text-sm font-medium focus:border-orange-400 appearance-none cursor-pointer">
                                <option value="All">All Types</option>
                                <option value="Healthy">Healthy ü•ó</option>
                                <option value="Main Course">Main Course ü•ò</option>
                                <option value="Snack">Snack ü•ü</option>
                                <option value="Side Dish">Side Dish ü•ó</option>
                                <option value="Dessert">Dessert üßÅ</option>
                                <option value="Beverage">Beverage ü•§</option>
                            </select>
                            <i data-lucide="chevron-down" class="absolute right-3 top-3 w-4 h-4 text-slate-400 pointer-events-none"></i>
                        </div>

                         <!-- Diet -->
                         <div class="relative group">
                            <select id="dietFilter" class="w-full pl-3 pr-8 py-2.5 bg-white/60 border border-slate-200 rounded-xl text-sm font-medium focus:border-orange-400 appearance-none cursor-pointer">
                                <option value="All">All Diets</option>
                                <option value="Veg">Veg Only ü•¨</option>
                                <option value="Non-Veg">Non-Veg üçó</option>
                                <option value="Egg">Contains Egg ü•ö</option>
                            </select>
                            <i data-lucide="chevron-down" class="absolute right-3 top-3 w-4 h-4 text-slate-400 pointer-events-none"></i>
                        </div>
                        
                        <!-- Servings (Mobile) -->
                        <input type="number" id="mobileServings" min="1" max="30" value="2" onchange="document.getElementById('globalServings').value=this.value; updateServingsGlobal()" class="md:hidden w-full pl-3 pr-4 py-2.5 bg-white/60 border border-slate-200 rounded-xl text-sm font-medium" placeholder="Servings">
                    </div>

                    <!-- Action Buttons -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <button onclick="findRecipesLocal()" class="bg-white border-2 border-slate-200 hover:border-orange-500 hover:text-orange-600 text-slate-700 font-bold py-3 rounded-xl transition-all flex items-center justify-center gap-2 shadow-sm">
                            <i data-lucide="zap" class="w-4 h-4"></i> Match Recipes
                        </button>
                        <button onclick="generateWithAI()" class="bg-gradient-to-r from-orange-500 to-red-600 hover:from-orange-600 hover:to-red-700 text-white font-bold py-3 rounded-xl transition-all flex items-center justify-center gap-2 shadow-lg shadow-orange-500/20">
                            <i data-lucide="sparkles" class="w-4 h-4"></i> Ask AI Chef
                        </button>
                    </div>
                </div>
            </div>

            <!-- Dynamic Illustration -->
            <div class="hidden lg:block lg:col-span-4 relative h-[450px]">
                <div class="absolute inset-0 bg-gradient-to-br from-orange-200/40 to-transparent rounded-full opacity-60 blur-3xl"></div>
                <div class="w-full h-full rounded-[2.5rem] overflow-hidden shadow-2xl relative bg-slate-200">
                    <img src="https://image.pollinations.ai/prompt/gourmet%20chinese%20dim%20sum%20spread%20top%20view%20cinematic%20lighting?nologo=true" 
                         class="w-full h-full object-cover transform hover:scale-105 transition-transform duration-700"
                         alt="Food Spread"
                         onload="this.parentElement.classList.remove('bg-slate-200')">
                </div>
            </div>
        </div>

        <!-- Results Section -->
        <div id="resultsArea" class="hidden space-y-8">
            <div class="flex flex-col md:flex-row justify-between items-end gap-4 pb-4 border-b border-slate-200/50">
                <div>
                    <h2 class="text-3xl font-bold text-slate-900 serif" id="resultsTitle">Menu</h2>
                    <p class="text-slate-500 mt-1" id="resultsSubtitle">Matched to your pantry (60%+ match).</p>
                </div>
                <div class="flex items-center gap-3">
                    <span id="matchCount" class="text-sm font-bold text-orange-600 bg-orange-50 border border-orange-100 px-4 py-2 rounded-full"></span>
                </div>
            </div>
            
            <div id="recipesGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 pb-12">
                <!-- Recipe Cards go here -->
            </div>
        </div>
        
        <!-- Loaders -->
        <div id="aiLoader" class="hidden flex flex-col items-center justify-center py-20 animate-slide-up">
            <span class="loader mb-6"></span>
            <h3 class="text-2xl font-bold text-slate-800">Chef AI is designing your recipe...</h3>
            <p class="text-slate-500">Calculating nutrition and precise ratios for <span id="loaderServings">2</span> people.</p>
        </div>

    </main>

    <!-- History Modal -->
    <div id="historyModal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-md z-50 hidden flex items-center justify-center p-4 opacity-0 transition-opacity duration-300">
        <div class="bg-white rounded-3xl w-full max-w-2xl max-h-[80vh] flex flex-col transform scale-95 transition-transform duration-300">
            <div class="p-6 border-b border-slate-100 flex justify-between items-center bg-orange-50/50 rounded-t-3xl">
                <div>
                    <h3 class="text-2xl font-bold serif text-slate-900">Culinary Journal</h3>
                    <p class="text-xs text-slate-500">Your cooking history</p>
                </div>
                <button onclick="closeHistoryModal()" class="bg-white hover:bg-slate-50 text-slate-500 p-2 rounded-full shadow-sm transition-all">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <div class="p-6 overflow-y-auto custom-scrollbar flex-grow" id="historyList">
                <!-- History Items -->
            </div>
            <div class="p-4 border-t border-slate-100 text-center">
                <button onclick="clearHistory()" class="text-red-500 text-sm hover:underline">Clear History</button>
            </div>
        </div>
    </div>

    <!-- Detailed Recipe Modal -->
    <div id="recipeModal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-md z-50 hidden flex items-center justify-center p-4 opacity-0 transition-opacity duration-300">
        <div class="bg-white rounded-3xl w-full max-w-4xl max-h-[95vh] overflow-hidden shadow-2xl flex flex-col transform scale-95 transition-transform duration-300 relative" id="modalContent">
            
            <!-- Chat FAB -->
            <button onclick="toggleChat()" class="absolute bottom-6 right-6 z-50 bg-slate-900 hover:bg-orange-600 text-white p-4 rounded-full shadow-xl transition-all transform hover:scale-110 flex items-center justify-center group">
                <i data-lucide="message-circle" class="w-6 h-6"></i>
                <span class="absolute right-full mr-3 bg-slate-800 text-white text-xs font-bold px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap">Ask the Chef</span>
            </button>

            <!-- Chat Window -->
            <div id="chefChatWindow" class="absolute bottom-24 right-6 w-80 md:w-96 h-96 bg-white rounded-2xl shadow-2xl border border-slate-200 z-50 flex flex-col hidden transform origin-bottom-right transition-all duration-200">
                <div class="p-4 bg-slate-50 border-b border-slate-100 flex justify-between items-center rounded-t-2xl">
                    <div class="flex items-center gap-2">
                        <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                        <span class="font-bold text-slate-700 text-sm">ChefMate AI</span>
                    </div>
                    <button onclick="toggleChat()" class="text-slate-400 hover:text-slate-600"><i data-lucide="x" class="w-4 h-4"></i></button>
                </div>
                <div id="chatMessages" class="flex-grow overflow-y-auto p-4 flex flex-col bg-white custom-scrollbar">
                    <div class="chat-bubble-ai">Hello! I'm your AI Sous Chef. Ask me anything about this recipe! üë®‚Äçüç≥</div>
                </div>
                <div class="p-3 border-t border-slate-100 bg-slate-50 rounded-b-2xl">
                    <div class="flex gap-2">
                        <input type="text" id="chatInput" class="flex-grow bg-white border border-slate-200 rounded-xl px-3 py-2 text-sm focus:outline-none focus:border-orange-400" placeholder="Ask a question..." onkeypress="if(event.key === 'Enter') sendChat()">
                        <button onclick="sendChat()" class="bg-orange-500 hover:bg-orange-600 text-white p-2 rounded-xl transition-colors"><i data-lucide="send" class="w-4 h-4"></i></button>
                    </div>
                </div>
            </div>

            <!-- Modal Header (Image) -->
            <div class="relative h-56 w-full bg-slate-200 shrink-0 group overflow-hidden">
                 <img id="modalImage" src="" class="w-full h-full object-cover transition-transform duration-1000 group-hover:scale-105 opacity-0 transition-opacity duration-500" onload="this.classList.remove('opacity-0'); this.parentElement.classList.remove('bg-slate-200', 'skeleton-pulse');">
                 <div class="absolute inset-0 bg-gradient-to-t from-black/80 via-black/20 to-transparent"></div>
                 
                 <button onclick="closeModal()" class="absolute top-4 right-4 bg-white/20 hover:bg-white text-white hover:text-slate-900 backdrop-blur-md p-2 rounded-full transition-all z-20">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>

                <div class="absolute bottom-0 left-0 w-full p-6 text-white flex justify-between items-end">
                    <div>
                        <div class="flex gap-2 mb-2">
                             <span id="modalCuisine" class="text-[10px] font-bold uppercase tracking-wider bg-white/20 px-2 py-1 rounded-md backdrop-blur-sm">Cuisine</span>
                             <span id="modalDiet" class="text-[10px] font-bold uppercase tracking-wider bg-green-500/80 px-2 py-1 rounded-md backdrop-blur-sm">Diet</span>
                             <span id="modalType" class="text-[10px] font-bold uppercase tracking-wider bg-orange-500/80 px-2 py-1 rounded-md backdrop-blur-sm">Type</span>
                        </div>
                        <h3 id="modalTitle" class="text-3xl md:text-4xl font-bold serif mb-1 drop-shadow-md"></h3>
                    </div>
                    <!-- Live Servings Adjuster in Modal -->
                    <div class="hidden md:flex flex-col items-end bg-black/30 backdrop-blur-md p-3 rounded-xl border border-white/10">
                        <span class="text-xs text-slate-300 mb-1">Adjust Servings</span>
                        <div class="flex items-center gap-3">
                            <button onclick="adjustModalServings(-1)" class="hover:text-orange-400 transition-colors"><i data-lucide="minus-circle" class="w-5 h-5"></i></button>
                            <span id="modalServingDisplay" class="font-bold text-xl w-6 text-center">2</span>
                            <button onclick="adjustModalServings(1)" class="hover:text-orange-400 transition-colors"><i data-lucide="plus-circle" class="w-5 h-5"></i></button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal Body -->
            <div class="p-6 md:p-8 overflow-y-auto custom-scrollbar bg-white flex-grow">
                
                <!-- AI Pairings Section -->
                <div class="mb-6">
                    <button onclick="getPairing()" id="pairingBtn" class="inline-flex items-center gap-2 text-sm font-bold text-purple-600 bg-purple-50 hover:bg-purple-100 px-4 py-2 rounded-xl transition-colors border border-purple-100 mb-3 shadow-sm">
                        <i data-lucide="sparkles" class="w-4 h-4"></i> Suggest Wine & Sides (AI)
                    </button>
                    <div id="pairingResult" class="hidden p-4 bg-gradient-to-r from-purple-50 to-pink-50 rounded-2xl border border-purple-100 text-sm text-slate-700 animate-slide-up">
                        <!-- Content injected here -->
                    </div>
                </div>

                <!-- Nutrition Panel -->
                <div class="grid grid-cols-4 gap-4 mb-8 p-4 bg-slate-50 rounded-2xl border border-slate-100 text-center">
                    <div>
                        <span class="block text-xs text-slate-400 uppercase font-bold tracking-wider">Calories</span>
                        <span id="modalCal" class="text-lg font-bold text-slate-800">--</span>
                    </div>
                    <div>
                        <span class="block text-xs text-slate-400 uppercase font-bold tracking-wider">Protein</span>
                        <span id="modalProtein" class="text-lg font-bold text-green-600">--</span>
                    </div>
                    <div>
                        <span class="block text-xs text-slate-400 uppercase font-bold tracking-wider">Carbs</span>
                        <span id="modalCarbs" class="text-lg font-bold text-orange-600">--</span>
                    </div>
                    <div>
                        <span class="block text-xs text-slate-400 uppercase font-bold tracking-wider">Fats</span>
                        <span id="modalFats" class="text-lg font-bold text-yellow-600">--</span>
                    </div>
                </div>

                <div class="flex items-center gap-6 mb-8 text-sm font-medium text-slate-600 border-b border-slate-100 pb-4">
                    <span class="flex items-center gap-2"><i data-lucide="clock" class="w-5 h-5 text-orange-500"></i> <span id="modalTime"></span></span>
                    <span class="flex items-center gap-2"><i data-lucide="flame" class="w-5 h-5 text-orange-500"></i> <span id="modalDifficulty"></span></span>
                </div>

                <div class="grid md:grid-cols-3 gap-8">
                    <!-- Ingredients -->
                    <div class="md:col-span-1 space-y-4">
                        <div class="flex justify-between items-center">
                            <h4 class="font-bold text-slate-900 text-lg flex items-center gap-2">
                                <i data-lucide="shopping-bag" class="w-5 h-5 text-orange-500"></i> Ingredients
                            </h4>
                        </div>
                        <ul id="modalIngredients" class="space-y-3 text-sm text-slate-600 bg-slate-50 p-4 rounded-2xl"></ul>
                    </div>

                    <!-- Instructions -->
                    <div class="md:col-span-2 space-y-4 flex flex-col">
                        
                        <!-- Prep Section -->
                        <div id="modalPrepSection" class="hidden mb-6 bg-blue-50 border border-blue-100 rounded-2xl p-4">
                             <h4 class="font-bold text-blue-900 text-lg flex items-center gap-2 mb-3">
                                <i data-lucide="list-checks" class="w-5 h-5 text-blue-500"></i> Before You Start
                            </h4>
                            <ul id="modalPrepList" class="space-y-2 text-sm text-blue-800 list-disc pl-4"></ul>
                        </div>

                        <h4 class="font-bold text-slate-900 text-lg flex items-center gap-2">
                            <i data-lucide="chef-hat" class="w-5 h-5 text-orange-500"></i> Method
                        </h4>
                        <ol id="modalInstructions" class="space-y-4 text-slate-600 list-decimal pl-4 mb-4 flex-grow"></ol>
                        
                        <!-- Start Cooking CTA -->
                        <div class="mt-8">
                            <button onclick="startCookingMode()" class="w-full bg-slate-900 hover:bg-slate-800 text-white text-lg font-bold py-4 rounded-xl shadow-lg flex items-center justify-center gap-3 transition-transform hover:scale-[1.01]">
                                <i data-lucide="play-circle" class="w-6 h-6"></i> Start Cooking Mode
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Cooking Mode Overlay -->
    <div id="cookingMode" class="fixed inset-0 bg-white z-[60] hidden flex flex-col">
        <div class="bg-slate-900 text-white p-4 flex justify-between items-center shadow-lg shrink-0">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full bg-slate-800 flex items-center justify-center border border-slate-700">
                    <span id="cookingStepNum" class="font-bold text-xl text-orange-500">1</span>
                </div>
                <div>
                    <h4 id="cookingTitle" class="font-bold text-lg leading-none">Dish</h4>
                    <span class="text-xs text-slate-400">AI Assistant Active</span>
                </div>
            </div>
            <button onclick="exitCookingMode()" class="px-4 py-2 bg-slate-800 hover:bg-slate-700 rounded-lg text-sm font-medium transition-colors">Exit</button>
        </div>

        <div class="flex-grow flex flex-col md:flex-row overflow-hidden">
            <div class="w-full md:w-1/2 p-6 md:p-12 flex flex-col justify-start bg-slate-50 relative overflow-y-auto custom-scrollbar">
                <i data-lucide="utensils" class="absolute -bottom-10 -left-10 w-64 h-64 text-slate-200/50 rotate-12 pointer-events-none"></i>
                
                <div class="z-10 relative mt-8 md:mt-auto md:mb-auto">
                    <h2 class="text-2xl md:text-3xl font-bold text-slate-900 mb-6 serif leading-relaxed tracking-tight" id="cookingInstruction"></h2>
                    <div id="cookingTip" class="text-slate-600 text-base italic mb-8 border-l-4 border-orange-400 pl-4 py-2 bg-orange-50 rounded-r-lg hidden"></div>
                </div>
                
                <div id="timerContainer" class="hidden mb-8 z-10">
                    <button onclick="toggleTimer()" id="timerBtn" class="bg-white shadow-md text-slate-800 font-mono text-xl px-6 py-3 rounded-xl flex items-center gap-3 hover:bg-orange-50 transition-colors border border-slate-200">
                        <i data-lucide="timer" class="w-6 h-6"></i> <span id="timerDisplay">00:00</span>
                    </button>
                </div>

                <div id="aiFeedbackArea" class="hidden mt-4 p-5 rounded-xl border-l-4 transition-all z-10 bg-white shadow-md mb-8">
                    <div class="flex items-start gap-4">
                        <div id="aiFeedbackIcon" class="mt-1"></div>
                        <div>
                            <h5 class="font-bold text-base uppercase mb-2 tracking-wide" id="aiFeedbackTitle">AI Analysis</h5>
                            <p class="text-slate-700 leading-relaxed" id="aiFeedbackText"></p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="w-full md:w-1/2 bg-slate-900 relative flex flex-col items-center justify-center p-6 border-l border-slate-800">
                <div class="relative w-full max-w-md aspect-square bg-slate-800 rounded-2xl border-2 border-dashed border-slate-600 flex flex-col items-center justify-center overflow-hidden mb-6 group hover:border-orange-500/50 transition-colors">
                    <img id="imagePreview" class="absolute inset-0 w-full h-full object-cover hidden">
                    <div id="cameraPlaceholder" class="text-center p-6">
                        <div class="w-20 h-20 bg-slate-700 rounded-full flex items-center justify-center mx-auto mb-4 group-hover:bg-slate-600 transition-colors cursor-pointer">
                            <i data-lucide="camera" class="w-10 h-10 text-slate-400"></i>
                        </div>
                        <p class="text-slate-400 font-medium">Tap to Verify Step</p>
                    </div>
                    <input type="file" id="cameraInput" accept="image/*" class="absolute inset-0 opacity-0 cursor-pointer" onchange="handleImageUpload(this)">
                    <div id="analysisLoader" class="absolute inset-0 bg-black/80 flex flex-col items-center justify-center hidden z-10">
                        <span class="loader"></span>
                        <p class="text-white mt-4 font-medium animate-pulse">Consulting AI Chef...</p>
                    </div>
                </div>
                <div class="w-full max-w-md flex gap-3">
                    <button id="analyzeBtn" onclick="analyzeImage()" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-xl flex items-center justify-center gap-2 opacity-50 cursor-not-allowed" disabled>
                        <i data-lucide="scan-eye" class="w-5 h-5"></i> Analyze
                    </button>
                    <button onclick="nextStep()" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-xl flex items-center justify-center gap-2">
                        Next Step <i data-lucide="arrow-right" class="w-5 h-5"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        lucide.createIcons();

        // --- Secured API Key Logic ---
        // The API Key is Obfuscated (Base64) to prevent simple text scraping.
        // NOTE: Client-side encryption is never fully secure. This is obfuscation.
        const _0x1a2b = "QUl6YVN5Q1Z6WDR1ODZFR0RRYThhM25pUDhWMWlyTDJXYWpWTElR";

        function getKey() {
            // Decrypts the key at runtime when needed
            return atob(_0x1a2b);
        }

        // State
        let myIngredients = [];
        let currentRecipe = null;
        let currentStepIndex = 0;
        let timerInterval = null;
        let timeLeft = 0;
        let isTimerRunning = false;
        let currentImageBase64 = null;
        let userServings = 2; 
        let cookingHistory = JSON.parse(localStorage.getItem('chefmate_history') || '[]');
        let chatOpen = false;

        // --- Animated Background ---
        const emojis = ['ü•ï', 'üçÖ', 'ü•î', 'ü•¶', 'üåΩ', 'üçÜ', 'üçó', 'ü•©', 'ü•ö', 'üßÄ', 'üçû', 'üçö', 'üçù', 'üçú', 'üç±', 'ü•ò', 'ü•£', 'ü•ó', 'üçø', 'üßÇ', 'üå∂Ô∏è', 'üçã', 'ü•ë', 'ü¶ê', 'üçÑ'];
        const bgContainer = document.getElementById('floatingBg');
        for(let i=0; i<30; i++) {
            const span = document.createElement('span');
            span.textContent = emojis[Math.floor(Math.random() * emojis.length)];
            span.className = 'floating-item';
            span.style.left = Math.random() * 100 + '%';
            span.style.animationDuration = (Math.random() * 15 + 15) + 's';
            span.style.animationDelay = (Math.random() * 20) + 's';
            bgContainer.appendChild(span);
        }

        // --- History Logic ---
        function addToHistory(recipe) {
            const entry = { id: recipe.id, title: recipe.title, date: new Date().toLocaleDateString(), emoji: recipe.emoji };
            cookingHistory.unshift(entry);
            if (cookingHistory.length > 50) cookingHistory.pop();
            localStorage.setItem('chefmate_history', JSON.stringify(cookingHistory));
        }

        function openHistoryModal() {
            const list = document.getElementById('historyList');
            const modal = document.getElementById('historyModal');
            list.innerHTML = '';
            if (cookingHistory.length === 0) {
                list.innerHTML = '<div class="text-center text-slate-400 py-10">No history yet. Start cooking!</div>';
            } else {
                cookingHistory.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'flex items-center justify-between p-4 bg-slate-50 rounded-xl mb-3';
                    div.innerHTML = `<div class="flex items-center gap-3"><span class="text-2xl">${item.emoji}</span><div><h4 class="font-bold text-slate-800">${item.title}</h4><span class="text-xs text-slate-500">${item.date}</span></div></div><i data-lucide="check-circle" class="w-5 h-5 text-green-500"></i>`;
                    list.appendChild(div);
                });
            }
            lucide.createIcons();
            modal.classList.remove('hidden');
            setTimeout(() => { modal.classList.remove('opacity-0'); modal.children[0].classList.remove('scale-95'); modal.children[0].classList.add('scale-100'); }, 10);
        }

        function closeHistoryModal() {
            const modal = document.getElementById('historyModal');
            modal.classList.add('opacity-0');
            modal.children[0].classList.add('scale-95');
            setTimeout(() => modal.classList.add('hidden'), 300);
        }

        function clearHistory() {
            if(confirm("Clear all cooking history?")) {
                cookingHistory = [];
                localStorage.setItem('chefmate_history', JSON.stringify([]));
                openHistoryModal();
            }
        }

        // --- Massive Recipe Generator ---
        
        // 1. Base Templates (High Quality)
        const baseRecipes = [
            // Indian Veg
            { 
                id: 1, 
                title: "Paneer Butter Masala", 
                cuisine: "Indian", type: "Main Course", diet: "Veg", emoji: "ü•ò", time: "40m", baseServings: 4, difficulty: "Medium", 
                nutrition: { calories: "450", protein: "18g", carbs: "12g", fats: "35g" }, 
                ingredients: [
                    {name: "Paneer", qty: 400, unit: "g"}, {name: "Butter", qty: 50, unit: "g"}, 
                    {name: "Tomato Puree", qty: 300, unit: "ml"}, {name: "Cashew Paste", qty: 2, unit: "tbsp"}, 
                    {name: "Kashmiri Red Chili", qty: 1, unit: "tsp"}, {name: "Garam Masala", qty: 1, unit: "tsp"}, 
                    {name: "Kasuri Methi", qty: 1, unit: "tbsp"}, {name: "Salt", qty: 1, unit: "tsp"},
                    {name: "Water", qty: 1, unit: "cup"}, {name: "Fresh Cream", qty: 2, unit: "tbsp"}
                ], 
                prep: ["Cut paneer into 1-inch cubes.", "Soak cashews in warm water for 15 mins then grind to a paste.", "Puree tomatoes if using fresh."], 
                instructions: [
                    "Heat 1 tbsp butter in a non-stick pan on medium heat. Gently add paneer cubes and shallow fry for 2-3 minutes until golden. Remove and soak in warm water (keeps them soft).", 
                    "In the same pan, add remaining butter. Pour in tomato puree, red chili powder, and salt. Cook on medium heat for 8-10 minutes until the oil separates from the masala.", 
                    "Lower the flame. Stir in the cashew paste and mix vigorously to avoid lumps. Cook for 2 minutes.", 
                    "Add 1 cup of warm water to adjust the consistency. Bring to a gentle boil.", 
                    "Add the fried paneer cubes and garam masala. Cover and simmer on low heat for 5 minutes to let flavors absorb.", 
                    "Crush Kasuri Methi between your palms and sprinkle on top. Stir in fresh cream and turn off heat immediately."
                ], 
                tips: ["Soaking fried paneer in warm water prevents it from becoming rubbery."] 
            },
            
            { 
                id: 21, 
                title: "Kung Pao Chicken", 
                cuisine: "Chinese", type: "Main Course", diet: "Non-Veg", emoji: "ü•°", time: "30m", baseServings: 3, difficulty: "Medium", 
                nutrition: { calories: "350", protein: "25g", carbs: "15g", fats: "18g" }, 
                ingredients: [
                    {name: "Chicken Breast", qty: 400, unit: "g"}, {name: "Peanuts", qty: 50, unit: "g"}, 
                    {name: "Dried Red Chilies", qty: 5, unit: "pcs"}, {name: "Sichuan Peppercorns", qty: 1, unit: "tsp"},
                    {name: "Soy Sauce", qty: 2, unit: "tbsp"}, {name: "Vinegar", qty: 1, unit: "tbsp"},
                    {name: "Corn Flour", qty: 1, unit: "tbsp"}, {name: "Cooking Oil", qty: 2, unit: "tbsp"},
                    {name: "Garlic", qty: 3, unit: "cloves"}, {name: "Ginger", qty: 1, unit: "inch"}
                ], 
                prep: ["Dice chicken into bite-sized cubes.", "Marinate chicken with 1 tbsp soy sauce and corn flour for 10 mins.", "Chop ginger and garlic finely.", "Roast peanuts if raw."], 
                instructions: [
                    "Heat 1 tbsp oil in a wok or large pan over high heat. Add marinated chicken and stir-fry for 4-5 minutes until browned and cooked through. Remove and set aside.", 
                    "In the same wok, add remaining oil. Add dried chilies and peppercorns. Stir-fry for 30 seconds until fragrant (don't burn!).", 
                    "Add chopped ginger and garlic. Saut√© for another 30 seconds.", 
                    "Return the chicken to the pan. Add roasted peanuts.", 
                    "Pour in the sauce mixture (soy sauce, vinegar, sugar). Toss everything together on high heat for 1 minute until sauce coats the chicken glossy.", 
                    "Serve immediately with steamed rice."
                ], 
                tips: ["High heat is key for Chinese stir-fries to get that 'wok hei' flavor."] 
            },

            { 
                id: 300, 
                title: "Masala Chai", 
                cuisine: "Indian", type: "Beverage", diet: "Veg", emoji: "‚òï", time: "10m", baseServings: 2, difficulty: "Easy", 
                nutrition: { calories: "120", protein: "3g", carbs: "15g", fats: "4g" }, 
                ingredients: [
                    {name: "Full Fat Milk", qty: 1, unit: "cup"}, {name: "Water", qty: 1, unit: "cup"}, 
                    {name: "Tea Leaves (Black)", qty: 2, unit: "tsp"}, {name: "Fresh Ginger", qty: 1, unit: "inch"}, 
                    {name: "Cardamom Pods", qty: 2, unit: "pcs"}, {name: "Sugar", qty: 2, unit: "tsp"}
                ], 
                prep: ["Crush the ginger and cardamom pods (with skin) in a mortar and pestle."], 
                instructions: [
                    "In a saucepan, bring 1 cup of water to a rolling boil.", 
                    "Add the crushed ginger and cardamom. Boil for 2 minutes to extract flavors.", 
                    "Add tea leaves and sugar. Boil for another 1-2 minutes until the water turns dark red.", 
                    "Pour in the milk. Wait for the tea to rise and bubble up (watch carefully so it doesn't spill!).", 
                    "Lower the heat and let it simmer for 2 minutes for a creamy texture.", 
                    "Strain through a fine sieve into cups and serve hot."
                ], 
                tips: ["Aerating the tea (pouring it from a height) makes it frothy and tastier."] 
            }
        ];

        // 2. Procedural Generator Config
        const adjectives = ["Spicy", "Creamy", "Garlic", "Herbed", "Lemon", "Smoky", "Classic", "Homestyle", "Royal", "Cheesy", "Butter", "Pepper", "Roasted", "Grilled", "Steamed", "Crispy", "Golden", "Rich", "Tangy", "Zesty", "Malabar", "Chettinad", "Punjabi", "Mughlai", "Hyderabadi", "Schezwan", "Hunan", "Cantonese"];
        
        const mainIngredients = {
            "Indian": {
                "Veg": ["Paneer", "Aloo", "Gobi", "Mushroom", "Mixed Veg", "Chana", "Rajma", "Dal", "Spinach", "Okra", "Baingan", "Koina", "Baby Corn"],
                "Non-Veg": ["Chicken", "Mutton", "Fish", "Prawns", "Lamb", "Keema", "Rohu", "Crab"],
                "Egg": ["Egg", "Egg Masala", "Omelette"]
            },
            "Chinese": {
                "Veg": ["Tofu", "Bok Choy", "Mushroom", "Baby Corn", "Broccoli", "Cabbage", "Spring Onion"],
                "Non-Veg": ["Chicken", "Pork", "Beef", "Shrimp", "Duck"],
                "Egg": ["Egg"]
            },
            "Italian": {
                "Veg": ["Mushroom", "Tomato", "Spinach", "Zucchini", "Eggplant", "Bell Pepper", "Broccoli", "Artichoke"],
                "Non-Veg": ["Chicken", "Sausage", "Bacon", "Pancetta", "Shrimp", "Beef", "Meatball"],
                "Egg": ["Egg Frittata"]
            },
            "Mexican": {
                "Veg": ["Bean", "Corn", "Avocado", "Pepper", "Sweet Potato", "Cactus"],
                "Non-Veg": ["Chicken", "Beef", "Pork", "Chorizo", "Fish"],
                "Egg": ["Egg"]
            },
            "Asian": {
                "Veg": ["Tofu", "Bok Choy", "Mushroom", "Bamboo Shoot", "Lotus Root"],
                "Non-Veg": ["Chicken", "Beef", "Pork", "Duck", "Shrimp", "Squid"],
                "Egg": ["Egg"]
            },
            "American": {
                "Veg": ["Potato", "Macaroni", "Corn", "Squash"],
                "Non-Veg": ["Burger", "Steak", "Wings", "Ribs", "Turkey"],
                "Egg": ["Scrambled Egg"]
            },
            "Mediterranean": {
                "Veg": ["Chickpea", "Falafel", "Halloumi", "Olive"],
                "Non-Veg": ["Lamb", "Chicken Souvlaki", "Fish"],
                "Egg": ["Shakshuka"]
            }
        };

        const dishTypes = {
            "Main Course": ["Curry", "Masala", "Stew", "Rice", "Noodles", "Pasta", "Pizza", "Burger", "Bowl", "Casserole", "Biryani", "Pulao", "Roast", "Steak", "Gravy", "Stir Fry"],
            "Snack": ["Fry", "Tikca", "Kebab", "Roll", "Wrap", "Sandwich", "Toast", "Nugget", "Wing", "Dip", "Samosa", "Pakora", "Chaat", "Dim Sum", "Spring Roll", "Momos"],
            "Side Dish": ["Salad", "Soup", "Stir Fry", "Mash", "Roast Veg", "Bread", "Raita", "Chutney", "Kimchi"],
            "Beverage": ["Shake", "Smoothie", "Juice", "Tea", "Coffee", "Cooler", "Lassi", "Soda", "Mocktail", "Lemonade"],
            "Dessert": ["Cake", "Pie", "Pudding", "Ice Cream", "Halwa", "Kheer", "Tart", "Cookie", "Brownie", "Mousse"],
            "Healthy": ["Salad", "Bowl", "Soup", "Wrap", "Steamed", "Grilled", "Baked", "Detox"]
        };

        const cookingMethods = ["Grilled", "Fried", "Baked", "Roasted", "Steamed", "Saut√©ed", "Slow Cooked", "Stir Fried", "Simmered", "Boiled"];

        // 3. Generator Function with Detailed Instructions
        let generatedRecipes = [];
        let idCounter = 1000;

        function generateMassiveDatabase() {
            const cuisines = Object.keys(mainIngredients);
            const diets = ["Veg", "Non-Veg", "Egg"];
            const types = Object.keys(dishTypes);

            // Generate combinatorial recipes
            for (let c of cuisines) {
                for (let d of diets) {
                    const ingredientsList = mainIngredients[c][d];
                    if(!ingredientsList) continue;

                    for (let ing of ingredientsList) {
                        for (let t of types) {
                            // Pick a few random templates to generate multiple dishes per intersection
                            for (let i = 0; i < 2; i++) { 
                                const adj = adjectives[Math.floor(Math.random() * adjectives.length)];
                                const suffix = dishTypes[t][Math.floor(Math.random() * dishTypes[t].length)];
                                const title = `${adj} ${ing} ${suffix}`;
                                
                                // Mock Nutrition
                                const cal = Math.floor(Math.random() * 600 + 150);
                                const prot = Math.floor(Math.random() * 30 + 5);
                                const carb = Math.floor(Math.random() * 60 + 10);
                                const fat = Math.floor(Math.random() * 30 + 5);

                                // Detailed Instructions Logic
                                let instructions = [];
                                let prep = [];
                                
                                if (t === "Main Course" || t === "Healthy") {
                                    prep = [
                                        `Clean and chop ${ing} into bite-sized pieces.`,
                                        `Finely chop onion, tomato, garlic, and ginger.`,
                                        `Measure out all spices and liquids beforehand.`
                                    ];
                                    instructions = [
                                        `Heat 2 tbsp oil in a large pan or pot over medium flame. Once hot, add cumin/mustard seeds (if using) and let them splutter.`,
                                        `Add chopped onions and saut√© for 5-7 minutes until they turn translucent or golden brown. Stir frequently to prevent burning.`,
                                        `Add ginger-garlic paste and saut√© for another minute until the raw smell disappears.`,
                                        `Add the main ingredient (${ing}) along with turmeric and salt. Stir well to coat with the aromatics. Cook for 5 minutes on medium heat.`,
                                        `Pour in the sauce base (tomato puree/coconut milk/stock) and bring it to a gentle boil.`,
                                        `Lower the heat, cover the pot, and let it simmer for 15-20 minutes until the ${ing} is fully cooked and tender.`,
                                        `Adjust salt seasoning. Garnish generously with fresh herbs like coriander or parsley. Serve hot.`
                                    ];
                                } else if (t === "Snack") {
                                    prep = [`Preheat oven or heating oil depending on method.`, `Prepare batter or coating for ${ing}.`];
                                    instructions = [
                                        `Prepare a batter using flour, cornstarch, salt, and spices. Add water slowly to make a thick paste.`,
                                        `Dip the ${ing} pieces into the batter ensuring they are evenly coated.`,
                                        `Heat oil in a deep frying pan. To check if hot enough, drop a small drop of batter; it should sizzle up immediately.`,
                                        `Carefully drop the coated ${ing} pieces into the hot oil. Do not overcrowd the pan.`,
                                        `Fry on medium heat for 6-8 minutes until the outer layer is golden brown and crispy.`,
                                        `Remove with a slotted spoon and drain on paper towels. Serve hot with chutney or ketchup.`
                                    ];
                                } else {
                                    // Fallback / Simple
                                    prep = [`Wash and prep all vegetables/fruits.`, `Gather all equipment.`];
                                    instructions = [
                                        `Combine base ingredients (${ing}) in a large bowl or mixer.`,
                                        `Add seasonings, liquids, or dressings as required for this recipe.`,
                                        `Mix or blend thoroughly until the desired consistency is reached.`,
                                        `Taste and adjust sweetness/salt/spice levels.`,
                                        `Chill in the refrigerator for 30 minutes if serving cold, or serve immediately.`
                                    ];
                                }

                                generatedRecipes.push({
                                    id: idCounter++,
                                    title: title,
                                    cuisine: c,
                                    diet: d,
                                    type: t,
                                    emoji: getEmoji(t),
                                    time: `${Math.floor(Math.random() * 40 + 10)}m`,
                                    baseServings: 2,
                                    difficulty: "Medium",
                                    nutrition: { calories: cal, protein: `${prot}g`, carbs: `${carb}g`, fats: `${fat}g` },
                                    ingredients: [
                                        {name: ing, qty: 200, unit: "g"},
                                        {name: "Onion", qty: 1, unit: "pc"},
                                        {name: "Tomato", qty: 1, unit: "pc"},
                                        {name: "Cooking Oil", qty: 2, unit: "tbsp"},
                                        {name: "Salt", qty: 1, unit: "tsp"},
                                        {name: "Water", qty: 1, unit: "cup"},
                                        {name: "Spice Mix", qty: 1, unit: "tbsp"}
                                    ],
                                    prep: prep,
                                    instructions: instructions,
                                    tips: ["Cook on medium heat for best results.", "Adjust spices to taste.", "Rest the dish for 5 mins before serving."]
                                });
                            }
                        }
                    }
                }
            }
        }

        function getEmoji(type) {
            const map = {
                "Main Course": "ü•ò", "Snack": "ü•ü", "Side Dish": "ü•ó", 
                "Beverage": "ü•§", "Dessert": "üç∞", "Healthy": "ü•ó"
            };
            return map[type] || "üçΩÔ∏è";
        }

        // Run Generator
        generateMassiveDatabase();
        const allRecipes = [...baseRecipes, ...generatedRecipes];

        // --- AI Features (Pairing & Chat) ---

        async function getPairing() {
            const key = getKey();

            const btn = document.getElementById('pairingBtn');
            const res = document.getElementById('pairingResult');
            
            btn.disabled = true;
            btn.innerHTML = '<span class="loader w-3 h-3 border-2 border-purple-600 border-b-transparent inline-block mr-2"></span> Sommelier Thinking...';
            
            const prompt = `Suggest a perfect beverage pairing (wine/drink) and a side dish for: "${currentRecipe.title}" (${currentRecipe.cuisine}). Return strictly JSON: { "drink": "Name - Short 1 sentence reason", "side": "Name - Short 1 sentence reason" }`;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${key}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }],
                        generationConfig: { responseMimeType: "application/json" }
                    })
                });
                
                const data = await response.json();
                if (!response.ok) throw new Error(data.error?.message || 'API Error');

                const candidate = data.candidates?.[0]?.content?.parts?.[0]?.text;
                if (!candidate) throw new Error("No response text");

                const cleanJson = candidate.replace(/```json\n?|```/g, '').trim();
                const result = JSON.parse(cleanJson);
                
                res.innerHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="flex items-start gap-3">
                            <div class="bg-white p-2 rounded-lg shadow-sm text-xl">üç∑</div>
                            <div><strong class="block text-purple-900">Beverage Pairing</strong> ${result.drink}</div>
                        </div>
                        <div class="flex items-start gap-3">
                            <div class="bg-white p-2 rounded-lg shadow-sm text-xl">ü•ó</div>
                            <div><strong class="block text-purple-900">Side Dish</strong> ${result.side}</div>
                        </div>
                    </div>
                `;
                res.classList.remove('hidden');
                btn.innerHTML = '<i data-lucide="check" class="w-4 h-4"></i> Pairings Generated';
                
            } catch (e) {
                console.error(e);
                btn.innerHTML = '<i data-lucide="alert-circle" class="w-4 h-4"></i> Failed. Try again.';
                btn.disabled = false;
                alert("AI Error: " + e.message);
            }
        }

        function toggleChat() {
            const chatWindow = document.getElementById('chefChatWindow');
            chatOpen = !chatOpen;
            if(chatOpen) {
                chatWindow.classList.remove('hidden');
                setTimeout(() => document.getElementById('chatInput').focus(), 100);
            } else {
                chatWindow.classList.add('hidden');
            }
        }

        async function sendChat() {
            const key = getKey();

            const input = document.getElementById('chatInput');
            const msg = input.value.trim();
            if(!msg) return;

            // Add User Message
            const container = document.getElementById('chatMessages');
            container.innerHTML += `<div class="chat-bubble-user">${msg}</div>`;
            input.value = '';
            container.scrollTop = container.scrollHeight;

            // Add Typing Indicator
            const typingId = 'typing-' + Date.now();
            container.innerHTML += `
                <div id="${typingId}" class="chat-bubble-ai flex gap-1 items-center py-4">
                    <div class="typing-dot" style="animation-delay: 0s"></div>
                    <div class="typing-dot" style="animation-delay: 0.2s"></div>
                    <div class="typing-dot" style="animation-delay: 0.4s"></div>
                </div>`;
            container.scrollTop = container.scrollHeight;

            // Context Construction
            const ingredients = currentRecipe.ingredients.map(i => i.name).join(', ');
            const prompt = `You are a friendly, expert chef. The user is cooking "${currentRecipe.title}". 
            Ingredients: ${ingredients}. 
            Instructions: ${currentRecipe.instructions.join('. ')}.
            User Query: "${msg}". 
            Answer concisely, encouragingly, and professionally. Use emojis.`;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${key}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                
                const data = await response.json();
                if (!response.ok) throw new Error(data.error?.message || 'API Error');

                const reply = data.candidates[0].content.parts[0].text;

                // Remove typing and add reply
                document.getElementById(typingId).remove();
                container.innerHTML += `<div class="chat-bubble-ai">${reply}</div>`;
                container.scrollTop = container.scrollHeight;

            } catch (e) {
                if(document.getElementById(typingId)) document.getElementById(typingId).remove();
                container.innerHTML += `<div class="chat-bubble-ai text-red-500">Error: ${e.message}</div>`;
            }
        }

        // --- Core Logic (Unchanged) ---
        function updateServingsGlobal() {
            const val = document.getElementById('globalServings').value;
            userServings = parseInt(val) || 1;
            if(userServings < 1) userServings = 1;
            if(userServings > 30) userServings = 30;
            document.getElementById('mobileServings').value = userServings;
            document.getElementById('globalServings').value = userServings;
            document.getElementById('loaderServings').innerText = userServings;
            if(!document.getElementById('recipeModal').classList.contains('hidden')) {
                renderModalIngredients();
            }
        }

        function adjustModalServings(delta) {
            let s = userServings + delta;
            if(s < 1) s = 1;
            if(s > 30) s = 30;
            userServings = s;
            document.getElementById('globalServings').value = s;
            document.getElementById('mobileServings').value = s;
            document.getElementById('modalServingDisplay').textContent = s;
            renderModalIngredients();
        }

        const input = document.getElementById('ingredientInput');
        const tagsContainer = document.getElementById('tagsContainer');
        const emptyState = document.getElementById('emptyState');
        const resultsArea = document.getElementById('resultsArea');
        const recipesGrid = document.getElementById('recipesGrid');

        input.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') addFromInput();
        });

        function addFromInput() {
            const val = input.value.trim().toLowerCase();
            if (val) {
                const items = val.split(',').map(s => s.trim()).filter(s => s.length > 0);
                items.forEach(item => {
                    if (!myIngredients.includes(item)) {
                        myIngredients.push(item);
                    }
                });
                renderTags();
                input.value = '';
            }
        }

        function removeIngredient(name) {
            myIngredients = myIngredients.filter(i => i !== name);
            renderTags();
        }

        function renderTags() {
            tagsContainer.innerHTML = '';
            if (myIngredients.length === 0) {
                tagsContainer.appendChild(emptyState);
                return;
            }
            myIngredients.forEach(ing => {
                const tag = document.createElement('div');
                tag.className = 'animate-slide-up bg-orange-50 border border-orange-200 text-orange-800 px-3 py-1.5 rounded-lg flex items-center gap-2 shadow-sm text-sm font-medium transition-all hover:bg-orange-100';
                tag.innerHTML = `${ing} <button onclick="removeIngredient('${ing}')" class="text-orange-400 hover:text-red-500"><i data-lucide="x" class="w-3 h-3"></i></button>`;
                tagsContainer.appendChild(tag);
            });
            lucide.createIcons();
        }

        function findRecipesLocal() {
            if (myIngredients.length === 0) {
                alert("Please add at least one ingredient!");
                return;
            }

            const cuisineFilter = document.getElementById('cuisineFilter').value;
            const dietFilter = document.getElementById('dietFilter').value;
            const dishTypeFilter = document.getElementById('dishTypeFilter').value;

            resultsArea.classList.remove('hidden');

            const scoredRecipes = allRecipes.map(recipe => {
                // Apply Filters
                if (cuisineFilter !== 'All' && recipe.cuisine !== cuisineFilter) return { ...recipe, matchCount: 0, percentage: 0 };
                if (dietFilter !== 'All') {
                    if (dietFilter === 'Veg' && recipe.diet !== 'Veg') return { ...recipe, matchCount: 0, percentage: 0 };
                    if (dietFilter === 'Non-Veg' && recipe.diet !== 'Non-Veg') return { ...recipe, matchCount: 0, percentage: 0 };
                    if (dietFilter === 'Egg' && recipe.diet !== 'Egg') return { ...recipe, matchCount: 0, percentage: 0 };
                }
                // Handle Dish Type / Healthy logic
                if (dishTypeFilter !== 'All') {
                    if(dishTypeFilter === 'Healthy' && recipe.type !== 'Healthy') return { ...recipe, matchCount: 0, percentage: 0 };
                    else if(dishTypeFilter !== 'Healthy' && recipe.type !== dishTypeFilter && recipe.type !== 'Healthy') return { ...recipe, matchCount: 0, percentage: 0 };
                }

                // Ingredient Match
                let matchCount = 0;
                recipe.ingredients.forEach(rIng => {
                    const rName = rIng.name.toLowerCase();
                    if (myIngredients.some(uIng => rName.includes(uIng) || uIng.includes(rName))) {
                        matchCount++;
                    }
                });
                
                // Bonus match for title containing ingredient
                if (matchCount === 0) {
                     if (myIngredients.some(uIng => recipe.title.toLowerCase().includes(uIng))) {
                        matchCount = 1; // Minimal match
                     }
                }

                const totalIng = recipe.ingredients.length;
                const percentage = Math.round((matchCount / totalIng) * 100);

                return {
                    ...recipe,
                    matchCount: matchCount,
                    percentage: percentage,
                    isAI: false
                };
            })
            .filter(r => r.matchCount > 0) // Show any recipe with at least 1 match
            .sort((a, b) => b.percentage - a.percentage);

            renderGrid(scoredRecipes);
        }

        function renderGrid(recipes) {
            recipesGrid.innerHTML = '';
            document.getElementById('matchCount').textContent = `${recipes.length} Found`;

            if(recipes.length === 0) {
                recipesGrid.innerHTML = `<div class="col-span-full text-center py-12 text-slate-500 bg-white rounded-3xl border border-slate-100 p-8 shadow-sm">
                    <p class="text-lg font-bold text-slate-700 mb-2">No matching recipes found.</p>
                    <p class="text-sm">Try adding different ingredients or selecting 'All' in filters, or ask the AI Chef!</p>
                </div>`;
                return;
            }

            recipes.slice(0, 100).forEach((recipe, index) => {
                const imgUrl = `https://image.pollinations.ai/prompt/cooked%20dish%20${encodeURIComponent(recipe.title)}%20${recipe.cuisine}%20food%20photography%20high%20quality?width=400&height=300&nologo=true&seed=${recipe.id}`;

                const card = document.createElement('div');
                card.className = `recipe-card bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden cursor-pointer flex flex-col h-full opacity-0 animate-slide-up relative group`;
                card.style.animationDelay = `${Math.min(index * 0.05, 1)}s`;
                card.onclick = () => openModal(recipe, imgUrl);

                let badgeColor = "bg-orange-100 text-orange-700";
                if (recipe.percentage >= 80) badgeColor = "bg-green-100 text-green-700";
                else if (recipe.percentage >= 50) badgeColor = "bg-yellow-100 text-yellow-700";
                else badgeColor = "bg-slate-100 text-slate-600"; // Grey for low match

                card.innerHTML = `
                    <div class="h-44 relative overflow-hidden bg-slate-200 skeleton-pulse">
                        <img src="${imgUrl}" class="w-full h-full object-cover transform transition-transform duration-700 group-hover:scale-110 opacity-0 transition-opacity duration-300" loading="lazy" onload="this.classList.remove('opacity-0'); this.parentElement.classList.remove('skeleton-pulse', 'bg-slate-200');">
                        <div class="absolute inset-0 bg-gradient-to-t from-black/60 to-transparent"></div>
                        <span class="absolute bottom-3 right-3 text-3xl drop-shadow-md transform group-hover:scale-125 transition-transform">${recipe.emoji}</span>
                        
                        <div class="absolute top-3 left-3 flex gap-1 flex-wrap">
                             <span class="${badgeColor} backdrop-blur text-[10px] font-bold px-2 py-1 rounded-full uppercase tracking-wide shadow-sm">${recipe.percentage}% Match</span>
                        </div>
                    </div>
                    <div class="p-5 flex flex-col flex-grow">
                        <h3 class="font-bold text-xl text-slate-900 leading-tight mb-2 serif group-hover:text-orange-600 transition-colors line-clamp-2">${recipe.title}</h3>
                        <p class="text-xs text-slate-400 mb-4 line-clamp-2">
                            ${recipe.nutrition ? `<span class="text-green-600 font-bold">${recipe.nutrition.calories} cal</span> ‚Ä¢ ` : ''} 
                            ${recipe.ingredients.slice(0,3).map(i => i.name).join(', ')}...
                        </p>
                        <div class="mt-auto flex items-center justify-between text-xs font-semibold text-slate-500 border-t border-slate-100 pt-3">
                            <span class="flex items-center gap-1"><i class="w-3.5 h-3.5" data-lucide="clock"></i> ${recipe.time}</span>
                            <span class="flex items-center gap-1"><i class="w-3.5 h-3.5" data-lucide="flame"></i> ${recipe.difficulty}</span>
                        </div>
                    </div>
                `;
                recipesGrid.appendChild(card);
            });
            lucide.createIcons();
        }

        async function generateWithAI() {
            const key = getKey();

            if (myIngredients.length === 0) {
                alert("Please add ingredients first.");
                return;
            }
            
            const loader = document.getElementById('aiLoader');
            resultsArea.classList.add('hidden');
            loader.classList.remove('hidden');
            loader.scrollIntoView({behavior: 'smooth'});

            const diet = document.getElementById('dietFilter').value;
            const type = document.getElementById('dishTypeFilter').value;

            const promptText = `I have: ${myIngredients.join(', ')}. Create a unique ${diet === 'All' ? '' : diet} ${type === 'All' ? 'dish' : type} recipe for ${userServings} servings. 
            Return strictly JSON: { 
                "title": "Name", 
                "cuisine": "Type", 
                "diet": "${diet === 'All' ? 'Veg' : diet}", 
                "type": "${type === 'All' ? 'Main Course' : type}",
                "emoji": "üç≤", 
                "time": "30m", 
                "baseServings": ${userServings}, 
                "difficulty": "Medium", 
                "nutrition": { "calories": "number", "protein": "g", "carbs": "g", "fats": "g" },
                "ingredients": [{"name": "Specific Spice/Item", "qty": 100, "unit": "g"}],
                "prep": ["Prep step 1 (e.g. chop onion)", "Prep step 2"], 
                "instructions": ["Step 1 (include heat levels e.g. medium flame)", "Step 2"],
                "tips": ["Tip 1", "Tip 2"]
            }. IMPORTANT: Include specific flour types if baking. Ensure JSON is valid and complete.`;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${key}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: promptText }] }],
                        generationConfig: { 
                            responseMimeType: "application/json",
                            maxOutputTokens: 8192 
                        }
                    })
                });
                
                const data = await response.json();
                if (!response.ok) throw new Error(data.error?.message || 'API Error');
                
                const candidate = data.candidates?.[0]?.content?.parts?.[0]?.text;
                if (!candidate) throw new Error("No response text");

                // Clean Markdown formatting if present
                const cleanJson = candidate.replace(/```json\n?|```/g, '').trim();
                const aiRecipe = JSON.parse(cleanJson);
                
                aiRecipe.isAI = true;
                aiRecipe.percentage = 100; 
                aiRecipe.id = 'ai_' + Date.now();
                if(!aiRecipe.tips) aiRecipe.tips = ["Follow your instinct!", "Taste as you cook."];
                if(!aiRecipe.prep) aiRecipe.prep = ["Prepare all ingredients before starting."];

                loader.classList.add('hidden');
                resultsArea.classList.remove('hidden');
                renderGrid([aiRecipe]);
                confetti({ particleCount: 150, spread: 100, origin: { y: 0.6 }, colors: ['#F97316', '#FBBF24'] });
            } catch (e) {
                console.error(e);
                loader.classList.add('hidden');
                alert("AI Chef is busy or encountered an error: " + e.message);
            }
        }

        // --- Modal & Scaling Logic ---
        const modal = document.getElementById('recipeModal');
        const modalImage = document.getElementById('modalImage');

        function openModal(recipe, imgUrl) {
            currentRecipe = recipe;
            
            // Reset Chat & Pairing UI
            document.getElementById('chefChatWindow').classList.add('hidden');
            chatOpen = false;
            document.getElementById('chatMessages').innerHTML = `<div class="chat-bubble-ai">Hello! I'm your AI Sous Chef. Ask me anything about <strong>${recipe.title}</strong>! üë®‚Äçüç≥</div>`;
            document.getElementById('pairingResult').classList.add('hidden');
            document.getElementById('pairingBtn').disabled = false;
            document.getElementById('pairingBtn').innerHTML = '<i data-lucide="sparkles" class="w-4 h-4"></i> Suggest Wine & Sides (AI)';

            modalImage.parentElement.classList.add('bg-slate-200', 'skeleton-pulse');
            modalImage.classList.add('opacity-0');
            modalImage.src = imgUrl;
            
            document.getElementById('modalTitle').textContent = recipe.title;
            document.getElementById('modalCuisine').textContent = recipe.cuisine;
            document.getElementById('modalDiet').textContent = recipe.diet;
            document.getElementById('modalType').textContent = recipe.type;
            
            // Nutrition
            if(recipe.nutrition) {
                document.getElementById('modalCal').textContent = recipe.nutrition.calories;
                document.getElementById('modalProtein').textContent = recipe.nutrition.protein;
                document.getElementById('modalCarbs').textContent = recipe.nutrition.carbs;
                document.getElementById('modalFats').textContent = recipe.nutrition.fats;
            } else {
                document.getElementById('modalCal').textContent = "--";
                document.getElementById('modalProtein').textContent = "--";
                document.getElementById('modalCarbs').textContent = "--";
                document.getElementById('modalFats').textContent = "--";
            }

            // Diet Badge Color
            const dietBadge = document.getElementById('modalDiet');
            if(recipe.diet === 'Non-Veg') dietBadge.className = 'text-[10px] font-bold uppercase tracking-wider bg-red-500/90 text-white px-2 py-1 rounded-md backdrop-blur-sm';
            else if(recipe.diet === 'Egg') dietBadge.className = 'text-[10px] font-bold uppercase tracking-wider bg-yellow-500/90 text-white px-2 py-1 rounded-md backdrop-blur-sm';
            else dietBadge.className = 'text-[10px] font-bold uppercase tracking-wider bg-green-500/90 text-white px-2 py-1 rounded-md backdrop-blur-sm';

            document.getElementById('modalTime').textContent = recipe.time;
            document.getElementById('modalDifficulty').textContent = recipe.difficulty;
            document.getElementById('modalServingDisplay').textContent = userServings;

            renderModalIngredients();

            // Render Prep
            const prepSection = document.getElementById('modalPrepSection');
            const prepList = document.getElementById('modalPrepList');
            if (recipe.prep && recipe.prep.length > 0) {
                prepSection.classList.remove('hidden');
                prepList.innerHTML = '';
                recipe.prep.forEach(step => {
                    prepList.innerHTML += `<li>${step}</li>`;
                });
            } else {
                prepSection.classList.add('hidden');
            }

            // Render Instructions
            const instrList = document.getElementById('modalInstructions');
            instrList.innerHTML = '';
            recipe.instructions.forEach(step => {
                instrList.innerHTML += `<li>${step}</li>`;
            });

            lucide.createIcons();
            modal.classList.remove('hidden');
            requestAnimationFrame(() => {
                modal.classList.remove('opacity-0');
                modal.children[0].classList.remove('scale-95');
                modal.children[0].classList.add('scale-100');
            });
        }

        function renderModalIngredients() {
            const ingList = document.getElementById('modalIngredients');
            ingList.innerHTML = '';
            const ratio = userServings / currentRecipe.baseServings;
            
            currentRecipe.ingredients.forEach(ing => {
                let amount = ing.qty * ratio;
                amount = Math.round(amount * 10) / 10;
                const isOwned = myIngredients.some(u => u.includes(ing.name.toLowerCase()) || ing.name.toLowerCase().includes(u));
                
                ingList.innerHTML += `
                    <li class="flex justify-between items-center py-2 border-b border-slate-200/50 last:border-0">
                        <div class="flex items-center gap-3">
                            ${isOwned 
                                ? '<div class="w-5 h-5 rounded-full bg-green-100 flex items-center justify-center text-green-600"><i data-lucide="check" class="w-3 h-3"></i></div>' 
                                : '<div class="w-5 h-5 rounded-full bg-orange-100 flex items-center justify-center text-orange-400"><div class="w-2 h-2 bg-orange-400 rounded-full"></div></div>'}
                            <span class="${isOwned ? 'text-slate-800 font-semibold' : 'text-slate-500'}">${ing.name}</span>
                        </div>
                        <span class="font-mono font-bold text-slate-700 bg-white px-2 py-1 rounded shadow-sm border border-slate-100">${amount} <span class="text-xs text-slate-400">${ing.unit}</span></span>
                    </li>`;
            });
            lucide.createIcons();
        }

        function closeModal() {
            modal.classList.add('opacity-0');
            modal.children[0].classList.add('scale-95');
            setTimeout(() => modal.classList.add('hidden'), 300);
        }

        // --- Cooking Mode & Vision ---
        function startCookingMode() {
            closeModal();
            currentStepIndex = 0;
            document.getElementById('cookingMode').classList.remove('hidden');
            document.getElementById('cookingTitle').textContent = currentRecipe.title;
            renderStep();
        }

        function exitCookingMode() {
            document.getElementById('cookingMode').classList.add('hidden');
            stopTimer();
        }

        function renderStep() {
            document.getElementById('cookingStepNum').textContent = currentStepIndex + 1;
            const stepText = currentRecipe.instructions[currentStepIndex];
            document.getElementById('cookingInstruction').textContent = stepText;

            const tipBox = document.getElementById('cookingTip');
            if(currentRecipe.tips && currentRecipe.tips[currentStepIndex]) {
                tipBox.innerHTML = `<strong>Chef's Tip:</strong> ${currentRecipe.tips[currentStepIndex]}`;
                tipBox.classList.remove('hidden');
            } else if (currentRecipe.tips && currentRecipe.tips[0]) {
                 tipBox.innerHTML = `<strong>Chef's Tip:</strong> ${currentRecipe.tips[currentStepIndex % currentRecipe.tips.length]}`;
                 tipBox.classList.remove('hidden');
            } else {
                tipBox.classList.add('hidden');
            }

            const timeMatch = stepText.match(/(\d+)\s*(?:m|min|minute)/i);
            const timerContainer = document.getElementById('timerContainer');
            stopTimer();
            if (timeMatch) {
                timeLeft = parseInt(timeMatch[1]) * 60;
                timerContainer.classList.remove('hidden');
                document.getElementById('timerDisplay').textContent = `${Math.floor(timeLeft/60)}:00`;
            } else {
                timerContainer.classList.add('hidden');
            }

            document.getElementById('aiFeedbackArea').classList.add('hidden');
            document.getElementById('imagePreview').classList.add('hidden');
            document.getElementById('cameraPlaceholder').classList.remove('hidden');
            document.getElementById('analyzeBtn').disabled = true;
            document.getElementById('analyzeBtn').classList.add('opacity-50');
            currentImageBase64 = null;
        }

        function nextStep() {
            if (currentStepIndex < currentRecipe.instructions.length - 1) {
                currentStepIndex++;
                renderStep();
            } else {
                confetti({ particleCount: 200, spread: 100, origin: { y: 0.6 } });
                addToHistory(currentRecipe);
                alert("Dish Completed! Added to History.");
                exitCookingMode();
            }
        }

        function toggleTimer() {
            if (isTimerRunning) {
                stopTimer();
                document.getElementById('timerBtn').classList.remove('bg-orange-50', 'text-orange-600', 'border-orange-500');
            } else {
                isTimerRunning = true;
                const btn = document.getElementById('timerBtn');
                btn.classList.add('bg-orange-50', 'text-orange-600', 'border-orange-500');
                
                timerInterval = setInterval(() => {
                    if (timeLeft > 0) {
                        timeLeft--;
                        const m = Math.floor(timeLeft / 60).toString().padStart(2, '0');
                        const s = (timeLeft % 60).toString().padStart(2, '0');
                        document.getElementById('timerDisplay').textContent = `${m}:${s}`;
                    } else {
                        stopTimer();
                        alert("Timer Done!");
                    }
                }, 1000);
            }
        }

        function stopTimer() {
            clearInterval(timerInterval);
            isTimerRunning = false;
        }

        function handleImageUpload(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    currentImageBase64 = e.target.result.split(',')[1];
                    document.getElementById('imagePreview').src = e.target.result;
                    document.getElementById('imagePreview').classList.remove('hidden');
                    document.getElementById('cameraPlaceholder').classList.add('hidden');
                    document.getElementById('analyzeBtn').disabled = false;
                    document.getElementById('analyzeBtn').classList.remove('opacity-50');
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        async function analyzeImage() {
            const key = getKey();

            if (!currentImageBase64) return;
            document.getElementById('analysisLoader').classList.remove('hidden');
            
            const prompt = `User is cooking. Step: "${currentRecipe.instructions[currentStepIndex]}". Analyze the image. Return JSON: {"correct": boolean, "message": "Detailed feedback explanation in 2-3 sentences."}`;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${key}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [
                                { text: prompt },
                                { inlineData: { mimeType: "image/jpeg", data: currentImageBase64 } }
                            ]
                        }],
                        generationConfig: { 
                            responseMimeType: "application/json",
                            maxOutputTokens: 2000
                        }
                    })
                });

                const data = await response.json();
                if (!response.ok) throw new Error(data.error?.message || 'API Error');

                const candidate = data.candidates?.[0]?.content?.parts?.[0]?.text;
                if (!candidate) throw new Error("No analysis generated");

                const cleanJson = candidate.replace(/```json\n?|```/g, '').trim();
                const result = JSON.parse(cleanJson);
                
                document.getElementById('analysisLoader').classList.add('hidden');
                
                const area = document.getElementById('aiFeedbackArea');
                area.classList.remove('hidden');
                document.getElementById('aiFeedbackText').textContent = result.message;
                
                if(result.correct) {
                    area.className = "mt-4 p-5 rounded-xl border-l-4 transition-all z-10 bg-green-50 border-green-500 text-green-900 shadow-md mb-8";
                    document.getElementById('aiFeedbackIcon').innerHTML = '<i data-lucide="check-circle" class="w-6 h-6 text-green-600"></i>';
                } else {
                    area.className = "mt-4 p-5 rounded-xl border-l-4 transition-all z-10 bg-red-50 border-red-500 text-red-900 shadow-md mb-8";
                    document.getElementById('aiFeedbackIcon').innerHTML = '<i data-lucide="alert-circle" class="w-6 h-6 text-red-600"></i>';
                }
                lucide.createIcons();

            } catch (error) {
                console.error(error);
                document.getElementById('analysisLoader').classList.add('hidden');
                alert("Analysis failed: " + error.message);
            }
        }
    </script>
</body>
</html>
